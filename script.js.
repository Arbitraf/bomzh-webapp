// ВАЖНО: сюда потом впишем твой настоящий адрес Flask-сервера
const API_BASE = "https://jennifer-inviolate-unmentally.ngrok-free.dev";

const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const digBtn = document.getElementById("digBtn");

let userId = null;
if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
  userId = tg.initDataUnsafe.user.id;
} else {
  // Для теста в обычном браузере
  userId = 12345;
}

async function callAction(action) {
  try {
    digBtn.disabled = true;
    const res = await fetch(`${API_BASE}/action`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, action })
    });

    const data = await res.json();

    if (data.error) {
      logEl.textContent = "Ошибка: " + data.error;
      return;
    }

    const u = data.user;
    statusEl.textContent =
      `Уровень: ${u.level} (опыт: ${u.exp})\n` +
      `Рубли: ${u.money_rub} | Доллары: ${u.money_usd}\n` +
      `Энергия: ${u.energy}/${u.max_energy}`;

    logEl.textContent = "Действие выполнено: " + action;
  } catch (e) {
    logEl.textContent = "Сервер недоступен";
  } finally {
    digBtn.disabled = false;
  }
}

digBtn.addEventListener("click", () => {
  callAction("dig_trash");
});

// При первом открытии — обновить статус
callAction("collect_bottles");
