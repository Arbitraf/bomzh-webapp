// локальный API
const API_BASE = "http://127.0.0.1:5000";

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const digBtn = document.getElementById("digBtn");

// пока без Телеграма — просто фиктивный id
const userId = tg.initDataUnsafe.user.id;

async function callAction(action) {
  try {
    digBtn.disabled = true;

    const res = await fetch(`${API_BASE}/action`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, action })
    });

    const data = await res.json();

    if (data.error) {
      logEl.textContent = "Ошибка: " + data.error;
      return;
    }

    const u = data.user;
    statusEl.textContent =
      `Уровень: ${u.level} (опыт: ${u.exp})\n` +
      `Деньги: ${u.money} руб\n` +
      `Энергия: ${u.energy}/${u.max_energy}`;

    logEl.textContent = "Действие: " + action;
  } catch (e) {
    logEl.textContent = "Сервер недоступен: " + e;
  } finally {
    digBtn.disabled = false;
  }
}

digBtn.addEventListener("click", () => {
  callAction("dig_trash");
});

// при загрузке просто обновим статус
callAction("collect_bottles");
